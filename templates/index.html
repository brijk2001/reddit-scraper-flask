<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reddit Historical Scraper</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        margin: 20px;
        background-color: #f0f2f5;
        color: #333;
      }
      .container {
        max-width: 800px;
        margin: auto;
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      h1 {
        text-align: center;
        color: #ff4500;
        margin-bottom: 20px;
      }
      form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        padding: 20px 0;
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        margin-bottom: 20px;
      }
      .form-group {
        display: flex;
        flex-direction: column;
      }
      label {
        margin-bottom: 5px;
        font-weight: 600;
        color: #555;
      }
      input[type="text"],
      input[type="date"] {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px;
      }
      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 15px;
      }
      input[type="checkbox"] {
        transform: scale(1.2);
      }
      button {
        background-color: #0079d3;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
        grid-column: 1 / -1;
      }
      button:hover {
        background-color: #005bb5;
      }
      button:disabled {
        background-color: #999;
        cursor: not-allowed;
      }

      .job-list {
        margin-top: 20px;
      }
      .job-item {
        background-color: #fff;
        border: 1px solid #eee;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }
      .job-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
        margin-bottom: 10px;
      }
      .job-status {
        font-weight: normal;
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 0.9em;
      }
      .status-queued {
        background-color: #ffe0b2;
        color: #e65100;
      }
      .status-running {
        background-color: #c8e6c9;
        color: #388e3c;
      }
      .status-done {
        background-color: #bbdefb;
        color: #1565c0;
      }
      .status-error {
        background-color: #ffcdd2;
        color: #c62828;
      }

      .progress-bar-container {
        height: 10px;
        background-color: #eee;
        border-radius: 5px;
        margin-top: 5px;
        overflow: hidden;
      }
      .progress-bar {
        height: 100%;
        background-color: #ff4500;
        transition: width 0.5s;
      }
      .download-link {
        color: #0079d3;
        text-decoration: none;
        font-weight: bold;
        margin-top: 10px;
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Reddit Historical Data Scraper ðŸš€</h1>
      <p>
        Use the Pushshift-anchored method to scrape historical posts
        month-to-month and bypass the 1,000-post limit.
      </p>

      <form id="scrape-form">
        <div class="form-group">
          <label for="subreddit">Subreddit (e.g., wallstreetbets)</label>
          <input
            type="text"
            id="subreddit"
            name="subreddit"
            required
            placeholder="r/subreddit_name"
          />
        </div>
        <div class="form-group">
          <label for="start_date">Start Date (YYYY-MM-DD)</label>
          <input type="date" id="start_date" name="start_date" required />
        </div>
        <div class="form-group">
          <label for="end_date">End Date (YYYY-MM-DD)</label>
          <input type="date" id="end_date" name="end_date" required />
        </div>
        <div class="checkbox-group">
          <input
            type="checkbox"
            id="include_comments"
            name="include_comments"
          />
          <label for="include_comments"
            >Include Top-Level Comments (Slower)</label
          >
        </div>
        <button type="submit" id="submit-button">Start Scraping Job</button>
      </form>

      <h2>Active Jobs</h2>
      <div id="job-list" class="job-list">
        <p id="no-jobs">No active jobs. Start one above!</p>
      </div>
    </div>

    <script>
      const form = document.getElementById("scrape-form");
      const jobList = document.getElementById("job-list");
      const noJobs = document.getElementById("no-jobs");
      const jobs = {}; // Store job details

      // Polling interval (adjust as needed)
      const POLL_INTERVAL = 3000;

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const submitButton = document.getElementById("submit-button");
        submitButton.disabled = true;
        submitButton.textContent = "Submitting...";

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Basic validation
        if (new Date(data.start_date) > new Date(data.end_date)) {
          alert("Start date cannot be after end date.");
          submitButton.disabled = false;
          submitButton.textContent = "Start Scraping Job";
          return;
        }

        try {
          const response = await fetch("/start-job", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            const errorText = await response.text();
            alert(`Error: ${errorText}`);
            return;
          }

          const result = await response.json();
          const jobId = result.job_id;

          // Add job to local storage/state
          jobs[jobId] = {
            id: jobId,
            subreddit: data.subreddit,
            start: data.start_date,
            end: data.end_date,
            comments: data.include_comments === "on" ? "Yes" : "No",
            status: "queued",
            progress: 0,
            message: "Queued",
            element: createJobElement(jobId, data),
          };

          // Clear form and start polling
          form.reset();
          noJobs.style.display = "none";
          jobList.prepend(jobs[jobId].element);
          pollJobStatus(jobId);
        } catch (error) {
          console.error("Submission Error:", error);
          alert("An unexpected error occurred. Check the console.");
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = "Start Scraping Job";
        }
      });

      function createJobElement(jobId, data) {
        const div = document.createElement("div");
        div.className = "job-item";
        div.id = `job-${jobId}`;
        div.innerHTML = `
                <div class="job-header">
                    <span>Job ID: ${jobId} | r/${data.subreddit} (${data.start} to ${data.end})</span>
                    <span class="job-status status-queued" id="status-${jobId}">Queued</span>
                </div>
                <div id="message-${jobId}">Queued</div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-${jobId}" style="width: 0%"></div>
                </div>
            `;
        return div;
      }

      async function pollJobStatus(jobId) {
        const job = jobs[jobId];
        if (!job) return;

        try {
          const response = await fetch(`/job-status/${jobId}`);
          if (!response.ok) {
            jobs[jobId].status = "error";
            jobs[jobId].message = "Job not found or API error.";
            updateJobDisplay(jobId);
            return;
          }
          const statusData = await response.json();

          // Update local job data
          job.status = statusData.state;
          job.progress = statusData.progress || 0;
          job.message = statusData.message || "Processing...";
          job.downloadUrl = statusData.download_url;

          updateJobDisplay(jobId);

          if (job.status === "running" || job.status === "queued") {
            // Continue polling
            setTimeout(() => pollJobStatus(jobId), POLL_INTERVAL);
          }
        } catch (error) {
          console.error(`Polling error for job ${jobId}:`, error);
          job.status = "error";
          job.message = `Polling failed: ${error.message}`;
          updateJobDisplay(jobId);
        }
      }

      function updateJobDisplay(jobId) {
        const job = jobs[jobId];
        const statusEl = document.getElementById(`status-${jobId}`);
        const messageEl = document.getElementById(`message-${jobId}`);
        const progressEl = document.getElementById(`progress-${jobId}`);
        const jobItemEl = document.getElementById(`job-${jobId}`);

        if (!statusEl) return;

        // Update Status Badge
        statusEl.textContent = job.status.toUpperCase();
        statusEl.className = `job-status status-${job.status}`;

        // Update Message
        messageEl.innerHTML = job.message;

        // Update Progress Bar
        progressEl.style.width = `${job.progress}%`;

        // Final state actions
        if (job.status === "done" && job.downloadUrl) {
          messageEl.innerHTML += ` | <a href="${job.downloadUrl}" class="download-link" target="_blank">Download CSV</a>`;
          // Stop polling
        } else if (job.status === "error") {
          // Keep progress at 100 for visibility of failure
          progressEl.style.width = "100%";
          jobItemEl.style.backgroundColor = "#fff0f0";
          // Stop polling
        }
      }

      // Initial check to hide 'No active jobs' if necessary (though usually empty on start)
      if (Object.keys(jobs).length > 0) {
        noJobs.style.display = "none";
      }
    </script>
  </body>
</html>
