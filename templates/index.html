<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="utf-8" />
    <title>Reddit Scraper</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#6c5ce7" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --brand: #6c5ce7;
        --brand-2: #a66cff;
        --glass-bg: rgba(255, 255, 255, 0.12);
        --glass-stroke: rgba(255, 255, 255, 0.35);
        --shadow: 0 12px 40px rgba(20, 20, 40, 0.14);
        --text-muted: #7a8499;
      }
      [data-bs-theme="dark"] {
        --glass-bg: rgba(20, 20, 28, 0.35);
        --glass-stroke: rgba(255, 255, 255, 0.1);
        --text-muted: #9aa6bd;
      }
      html,
      body {
        height: 100%;
      }
      body {
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial,
          sans-serif;
        overflow-x: hidden;
        background: radial-gradient(
            120% 100% at 10% -10%,
            #eaeaff 0%,
            transparent 60%
          ),
          radial-gradient(110% 90% at 110% 0%, #f4e9ff 0%, transparent 55%),
          linear-gradient(180deg, #f7f8fc 0%, #eef1fb 60%, #e9ecf7 100%);
      }
      [data-bs-theme="dark"] body {
        background: radial-gradient(
            120% 100% at 10% -10%,
            #1e2030 0%,
            transparent 60%
          ),
          radial-gradient(110% 90% at 110% 0%, #1b1d2b 0%, transparent 55%),
          linear-gradient(180deg, #0f111a 0%, #141826 60%, #121422 100%);
      }
      .parallax {
        position: fixed;
        inset: -10vh 0 0 0;
        pointer-events: none;
        z-index: -1;
      }
      .p-layer {
        position: absolute;
        border-radius: 999px;
        filter: blur(20px);
        opacity: 0.55;
        will-change: transform;
      }
      .p1 {
        width: 42vmin;
        height: 42vmin;
        left: 6vw;
        top: 8vh;
        background: linear-gradient(135deg, #c9c2ff, #e8e3ff);
      }
      .p2 {
        width: 56vmin;
        height: 56vmin;
        right: -8vw;
        top: 2vh;
        background: linear-gradient(135deg, #f6d9ff, #e9f0ff);
      }
      .p3 {
        width: 36vmin;
        height: 36vmin;
        left: 55vw;
        top: 45vh;
        background: linear-gradient(135deg, #b7f0ff, #e9f5ff);
      }
      .glass {
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--glass-stroke);
        border-radius: 18px;
        box-shadow: var(--shadow);
      }
      .brand-btn.btn {
        --bs-btn-bg: var(--brand);
        --bs-btn-border-color: var(--brand);
        --bs-btn-hover-bg: #5a4be1;
        --bs-btn-hover-border-color: #5a4be1;
      }
      .progress {
        height: 10px;
        background: rgba(120, 120, 160, 0.15);
      }
      .progress-bar {
        background: linear-gradient(90deg, var(--brand), var(--brand-2));
      }
      .app-header {
        padding-block: 20px;
      }
      .wordmark {
        font-weight: 700;
        letter-spacing: 0.2px;
      }
      pre {
        white-space: pre-wrap;
        word-break: break-word;
        margin: 0;
      }
      @media (max-width: 575.98px) {
        .wordmark {
          font-size: 1.1rem;
        }
      }
    </style>
  </head>

  <body>
    <div class="parallax" aria-hidden="true">
      <div class="p-layer p1" data-speed="0.15"></div>
      <div class="p-layer p2" data-speed="0.08"></div>
      <div class="p-layer p3" data-speed="0.2"></div>
    </div>

    <header class="container app-header">
      <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
          <svg width="36" height="36" viewBox="0 0 64 64" aria-hidden="true">
            <defs>
              <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="#6c5ce7" />
                <stop offset="1" stop-color="#a66cff" />
              </linearGradient>
            </defs>
            <path
              d="M10 18a14 14 0 0 1 14-14h16a14 14 0 0 1 14 14v6a14 14 0 0 1-14 14H29l-8 8v-8H24A14 14 0 0 1 10 24z"
              fill="url(#g)"
              opacity=".95"
            />
            <text
              x="28"
              y="24"
              font-size="12"
              text-anchor="middle"
              fill="#fff"
              font-family="Inter,Arial"
              font-weight="700"
            >
              r/
            </text>
            <circle cx="44" cy="40" r="10" fill="#fff" opacity=".95" />
            <circle
              cx="44"
              cy="40"
              r="6.3"
              fill="none"
              stroke="#6c5ce7"
              stroke-width="3"
            />
            <rect
              x="51"
              y="46"
              width="12"
              height="4.5"
              rx="2.2"
              fill="#6c5ce7"
              transform="rotate(35 51 46)"
            />
          </svg>
          <div class="wordmark fs-4">Reddit Scraper</div>
        </div>
        <button id="themeBtn" class="btn btn-sm btn-outline-secondary">
          Theme
        </button>
      </div>
    </header>

    <main class="container pb-4" style="max-width: 1080px">
      <div class="row g-4 align-items-stretch">
        <!-- Form -->
        <div class="col-12 col-lg-5">
          <section class="glass p-4 h-100">
            <h4 class="mb-2">Scrape by date range</h4>
            <p class="text-muted mb-4">
              Choose a subreddit and a date range (inclusive).
            </p>

            <form id="startForm" class="d-grid gap-3">
              <div>
                <label class="form-label">Subreddit (without “r/”)</label>
                <div class="input-group">
                  <span class="input-group-text">r/</span>
                  <input
                    class="form-control"
                    name="subreddit"
                    placeholder="IndiaCoffee"
                    required
                  />
                </div>
              </div>

              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label">Start date</label>
                  <input
                    type="date"
                    class="form-control"
                    name="start_date"
                    required
                  />
                </div>
                <div class="col-6">
                  <label class="form-label">End date</label>
                  <input
                    type="date"
                    class="form-control"
                    name="end_date"
                    required
                  />
                </div>
              </div>

              <button class="btn brand-btn btn-lg" type="submit" id="goBtn">
                <span class="start-label">Start</span>
                <span
                  class="spinner-border spinner-border-sm ms-2 d-none"
                  id="goSpinner"
                  role="status"
                  aria-hidden="true"
                ></span>
              </button>

              <div class="small text-muted">
                Tip: Keep the tab open while it runs. The CSV auto-enables when
                ready.
              </div>
            </form>
          </section>
        </div>

        <!-- Status -->
        <div class="col-12 col-lg-7">
          <section class="glass p-4 h-100">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <h5 class="m-0">Job Status</h5>
              <a
                id="downloadBtn"
                class="btn btn-success disabled"
                href="#"
                download
                >Download CSV</a
              >
            </div>

            <div id="jobPanel" class="mb-3 d-none">
              <div
                class="progress mb-2"
                role="progressbar"
                aria-label="Scrape progress"
                aria-valuemin="0"
                aria-valuemax="100"
              >
                <div id="bar" class="progress-bar" style="width: 0%"></div>
              </div>
              <div id="jobMsg" class="text-muted">Starting…</div>
            </div>

            <div
              class="p-3 rounded-3"
              style="
                background: rgba(255, 255, 255, 0.55);
                border: 1px solid var(--glass-stroke);
              "
            >
              <pre id="preview" class="text-muted">
No job yet. Start a scrape to see live updates.</pre
              >
            </div>
          </section>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Theme toggle
      const themeBtn = document.getElementById("themeBtn");
      const savedTheme = localStorage.getItem("theme");
      const prefersDark =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;
      function setTheme(t) {
        document.documentElement.setAttribute("data-bs-theme", t);
        localStorage.setItem("theme", t);
      }
      setTheme(savedTheme || (prefersDark ? "dark" : "light"));
      themeBtn.addEventListener("click", () => {
        const cur = document.documentElement.getAttribute("data-bs-theme");
        setTheme(cur === "light" ? "dark" : "light");
      });

      // Light parallax
      const layers = Array.from(document.querySelectorAll(".p-layer"));
      let ticking = false;
      function onScroll() {
        if (!ticking) {
          window.requestAnimationFrame(() => {
            const y = window.scrollY || 0;
            layers.forEach((el) => {
              const speed = parseFloat(el.dataset.speed || 0.1);
              el.style.transform = "translate3d(0," + y * speed + "px,0)";
            });
            ticking = false;
          });
          ticking = true;
        }
      }
      document.addEventListener("scroll", onScroll, { passive: true });

      // Job flow
      const form = document.getElementById("startForm");
      const jobPanel = document.getElementById("jobPanel");
      const jobMsg = document.getElementById("jobMsg");
      const bar = document.getElementById("bar");
      const preview = document.getElementById("preview");
      const goBtn = document.getElementById("goBtn");
      const goSpinner = document.getElementById("goSpinner");
      const downloadBtn = document.getElementById("downloadBtn");

      let pollTimer = null;

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (pollTimer) {
          clearInterval(pollTimer);
          pollTimer = null;
        }

        jobPanel.classList.remove("d-none");
        jobMsg.textContent = "Starting…";
        bar.style.width = "0%";
        downloadBtn.classList.add("disabled");
        downloadBtn.removeAttribute("href");
        preview.textContent = "";

        goBtn.disabled = true;
        goSpinner.classList.remove("d-none");

        try {
          const resp = await fetch("/start-job", {
            method: "POST",
            body: new FormData(form),
          });
          if (!resp.ok) {
            const t = await resp.text().catch(() => resp.statusText);
            jobMsg.textContent = "Start error: " + t;
            goBtn.disabled = false;
            goSpinner.classList.add("d-none");
            return;
          }
          const { job_id } = await resp.json();
          preview.textContent =
            "Job started: " + job_id + "\nPolling every 2s…";
          pollTimer = setInterval(() => pollStatus(job_id), 2000);
        } catch (err) {
          jobMsg.textContent = "Network error: " + String(err);
          goBtn.disabled = false;
          goSpinner.classList.add("d-none");
        }
      });

      async function pollStatus(jobId) {
        try {
          const resp = await fetch(`/job-status/${jobId}`);
          if (!resp.ok) {
            const t = await resp.text();
            jobMsg.textContent = "Status error: " + t;
            clearInterval(pollTimer);
            pollTimer = null;
            goBtn.disabled = false;
            goSpinner.classList.add("d-none");
            return;
          }
          const data = await resp.json();
          preview.textContent = JSON.stringify(data, null, 2);
          bar.style.width = (data.progress || 0) + "%";

          if (data.state === "done") {
            jobMsg.textContent = data.message || "Complete.";
            downloadBtn.href = data.download_url || "#";
            downloadBtn.classList.remove("disabled");
            clearInterval(pollTimer);
            pollTimer = null;
            goBtn.disabled = false;
            goSpinner.classList.add("d-none");
          } else if (data.state === "error") {
            jobMsg.textContent = data.message || "Job failed.";
            clearInterval(pollTimer);
            pollTimer = null;
            goBtn.disabled = false;
            goSpinner.classList.add("d-none");
          } else {
            jobMsg.textContent = data.message || "Working…";
          }
        } catch (err) {
          jobMsg.textContent = "Polling error: " + String(err);
          clearInterval(pollTimer);
          pollTimer = null;
          goBtn.disabled = false;
          goSpinner.classList.add("d-none");
        }
      }
    </script>
  </body>
</html>
